@using Shared.Models.Areas.Finishing
@using Shared.ViewModels.Areas.Finishing
@using Newtonsoft.Json;
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer localizer

@model ProductionReportViewModel;
@*https://www.w3.org/WAI/tutorials/tables/irregular/  https://datatables.net/extensions/buttons/examples/column_visibility/index.html*@

<style>
    .hideextra {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
<div class="d-flex justify-content-center">
    <div class="spinner-border" role="status" id="myLoader" style="display:none">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<div id="TitlePage">
    <h1 class="display-4 text-center">@localizer["ProductionStatus"]</h1>
    <h2 class="display-5 text-center">@ViewBag.RunName</h2>
</div>
<div class="filter-div">
    <form style="height: 100%">

        <div style="margin-left: 50px">
            <label>
                @*Needs tooltip*@
                <img class="settings-circle circle buttom-icon" style="background:white; width:30px;height:30px;padding:3px" src="~/images/bwpaper.png">
                <input class="alt-toggle-box" type="checkbox" name="checkboxBW" value="1">
                <img />

            </label>
            <label style="margin: 15px;">
                <img class="settings-circle circle buttom-icon" style="background:white; width:30px;height:30px;padding:3px" src="~/images/printer color.png">
                <input class="alt-toggle-box" type="checkbox" name="checkboxBW" value="1">
                <img />
            </label>
        </div>
        <div id="text-buttons" style="margin-left: 10px;">
            <label class="btn btn-outline-dark">
                <input class="alt-toggle-box" type="checkbox" name="checkboxS" value="1">Simplex
            </label>
            <label class="btn btn-outline-dark">
                <input class="alt-toggle-box" type="checkbox" name="checkboxS" value="0">Duplex
            </label>
        </div>
        <div style="display: flex; position:absolute; right: 10px; bottom: 10 px;">
            <input class="btn btn-dark m-2" type="submit">
        </div>
        
    </form>

</div>
@if (Model == null)
{
    <tr><td colspan="5" class="text-center">No Model Data</td></tr>
}
else
{
    <div id="response" class="d-flex justify-content-center">
    </div>
    <div class=" my-1 d-flex justify-content-lg-start">       
        <form id="all" asp-area="Finishing" asp-controller="Print" asp-action="Print"
          data-ajax="true"
          data-ajax-method="POST"
          data-ajax-mode="replace"
          data-ajax-update="#response"
          data-ajax-loading="myLoader">
            <b class="mx-3">@localizer["Printer"]</b>
            <select id="Printer" name="Printer">
                @foreach (PrinterInfo printer in Model.Printers)
                {
                    string resValue = printer.PlexFeature.ToString() + "|" + printer.ColorFeature.ToString() + "|" + printer.ResValue;
                    <option value="@resValue">@printer.Description</option>
                }
            </select>
            @if (ViewBag.PermissionIgnoreFilePrinterSpecs)
            {
                <label class="checkbox mx-3 my-1"> @Html.CheckBox("checkAll", false) @localizer["AllFiles"]</label>
            }
            <p class="my-3 d-flex justify-content-lg-start"><input type="submit" name="Submit" class="btn btn-block btn-success" /></p>
            @{
                string Level1Name = "detail";
                int count = 0;
                string idValue = "";
                string nameValue = "";
                string cValue = "";
            }
            @foreach (ProdExpeditionElement eInfo in Model.ProductionReport)
            {
                <table>
                    <thead><tr><td>@eInfo.ExpCompanyName - @eInfo.ExpeditionTypeDesc</td></tr></thead>
                    <tbody>
                        <tr>
                            <td>
                                @foreach (ProdServiceElement sInfo in eInfo.ServiceList)
                                {
                                    <table>
                                        <thead><tr><td>@sInfo.ServiceTaskDec</td></tr></thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    @foreach (ProdMaterialElement mInfo in sInfo.MediaMaterialList)
                                                    {
                                                        int PrintTotal = 0;
                                                        int PostObjsTotal = 0;
                                                        Dictionary<string, int> PaperTotal = new Dictionary<string, int>();
                                                        Dictionary<string, int> StationTotal = new Dictionary<string, int>();
                                                        <table>
                                                            <thead>
                                                                <tr>
                                                                    <td>
                                                                        @localizer["Papers"] [@mInfo.PaperMaterialList]
                                                                        @if (!string.IsNullOrEmpty(mInfo.StationMaterialList))
                                                                        {
                                                                            <p/>@localizer["AdditionalInserts"]
                                                                            @(" [" + mInfo.StationMaterialList + "]")
                                                                        }
                                                                    </td>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>
                                                                        <table class="table table-sm table-hover table-collapse-seperate">
                                                                            <col>
                                                                            <col>
                                                                            <col>
                                                                            @{
                                                                                int printingSpan = 5 + mInfo.FileList.First().PaperTotals.Keys.Count;
                                                                            }
                                                                            <colgroup span="@printingSpan"></colgroup>
                                                                            @{
                                                                                int envelopingSpan = 4;
                                                                                if (mInfo.StationList.Length > 0)
                                                                                {
                                                                                    envelopingSpan += mInfo.FileList.First().StationTotals.Keys.Count;
                                                                                }
                                                                            }
                                                                            <colgroup span="@envelopingSpan"></colgroup>
                                                                            <colgroup span="5"></colgroup>
                                                                            <thead id="bootstrap-overrides" class="table-info sticky-header">
                                                                                <tr class="text-center">
                                                                                    <th class="headcol" rowspan="3" scope="col">@localizer["Files"]</th>@*FileName RegistShortFileName*@
                                                                                    <th rowspan="3" scope="col">@localizer["ServiceTaskCode"]</th>@*ServiceTaskCode*@
                                                                                    <th colspan="@printingSpan" scope="colgroup">@localizer["Printing"]</th>
                                                                                    <th colspan="@envelopingSpan" scope="colgroup">@localizer["Fullfilling"]</th>
                                                                                    <th colspan="5" scope="colgroup">@localizer["Expedition"]</th>
                                                                                </tr>
                                                                                <tr class="text-center">
                                                                                    <th rowspan="2" scope="col">@localizer["PrinterOperator"]</th>@*PrinterOperator + Printer*@
                                                                                    <th rowspan="2" scope="col">@localizer["PlexCode"]</th>@*PlexCode*@
                                                                                    <th rowspan="2" scope="col">@localizer["TotalPrint"]</th>@*TotalPrint*@
                                                                                    <th colspan="2" scope="colgroup" class="hideextra">@localizer["SequenceNumber"]</th>
                                                                                    <th colspan="@mInfo.FileList.First().PaperTotals.Keys.Count" scope="colgroup">@localizer["Materials"]</th>
                                                                                    <th colspan="2" scope="colgroup">@localizer["Envelope"]</th>
                                                                                    <th rowspan="2" scope="col">@localizer["TotalPostObjs"]</th> @*TotalPostObjs*@
                                                                                    <th rowspan="2" scope="col">@localizer["ExpLevel"]</th>@*ExpLevel*@
                                                                                    @if (mInfo.StationList.Length > 0)
                                                                                    {
                                                                                        <th colspan="@mInfo.FileList.First().StationTotals.Keys.Count" scope="colgroup">@localizer["Stations"]</th>
                                                                                    }
                                                                                    <th rowspan="2" scope="col">@localizer["ExpCompanyCode"]</th>@*ExpCompanyCode*@
                                                                                    <th rowspan="2" scope="col">@localizer["ExpCenterCode"]</th>@*ExpCenterCode*@
                                                                                    <th rowspan="2" scope="col">@localizer["ExpeditionZone"]</th>@*ExpeditionZone*@
                                                                                    <th rowspan="2" scope="rowgroup">@localizer["ExpeditionType"]</th>@*ExpeditionType*@
                                                                                    <th rowspan="2" scope="rowgroup">@localizer["ExpeditionLevel"]</th>@*ExpeditionLevel*@
                                                                                </tr>
                                                                                <tr class="text-center">
                                                                                    <th scope="col">@localizer["StartSeqNum"]</th>@*StartSeqNum*@
                                                                                    <th scope="col">@localizer["EndSeqNum"]</th>@*EndSeqNum*@
                                                                                    @foreach (string paper in mInfo.FileList.First().PaperTotals.Keys)
                                                                                    {
                                                                                        <th scope="row">@paper</th>
                                                                                        PaperTotal.Add(paper, 0);
                                                                                    }
                                                                                    <th scope="col">@localizer["FullFillMaterialCode"]</th>@*FullFillMaterialCode*@
                                                                                    <th scope="col">@localizer["FullFillMaterialRef"]</th>@*FullFillMaterialRef*@
                                                                                    @if (mInfo.StationList.Length > 0)
                                                                                    {
                                                                                        @foreach (string station in mInfo.FileList.First().StationTotals.Keys)
                                                                                        {
                                                                                            <th scope="row">@station</th>
                                                                                            StationTotal.Add(station, 0);
                                                                                        }
                                                                                    }
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody id="bootstrap-overrides">
                                                                                @foreach (ProdFileInfo p in mInfo.FileList)
                                                                                {
                                                                                    <tr>
                                                                                        <td class="headcol" style="background: var(--lightestgrey)">
                                                                                            @if (!p.FilePrintedFlag)
                                                                                            {
                                                                                                string fJSON = JsonConvert.SerializeObject(p);
                                                                                                <div class='bx bx-printer' style="color:var(--evol-grey)">
                                                                                                    <input type="checkbox" name="FileCheck" id="@p.FilePlexType|@p.FileColor" value="@fJSON">
                                                                                                </div>
                                                                                                <label>@p.FileName</label>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <div class="disabled">@p.FileName</div>
                                                                                            }

                                                                                            @if (p.RegistDetailFileName != "")
                                                                                            {
                                                                                                @if (!p.RegistDetailFilePrintedFlag)
                                                                                                {
                                                                                                    ProdFileInfo pregist = p;
                                                                                                    pregist.FileName = p.RegistDetailFileName;
                                                                                                    pregist.ShortFileName = p.RegistDetailShortFileName;
                                                                                                    pregist.FilePrinterSpecs = p.RegistDetailFilePrinterSpecs;
                                                                                                    pregist.PrintRecNumber = p.RegistDetailFileRecNumber;
                                                                                                    string fJSON = JsonConvert.SerializeObject(pregist);
                                                                                                    <p />
                                                                                                    <div class='bx bx-printer' style="color:var(--evol-grey)">
                                                                                                        <input type="checkbox" name="FileCheck" id="@p.RegistDetailFilePlexType|@p.RegistDetailFileColor" value="@fJSON">
                                                                                                    </div>
                                                                                                    <label>@pregist.FileName</label>
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    <div class="disabled">@p.RegistDetailFileName</div>
                                                                                                }
                                                                                            }
                                                                                        </td>
                                                                                        <td>@sInfo.ServiceTaskCode</td>
                                                                                        <td>
                                                                                            @if (p.PrinterOperator != null)
                                                                                            {
                                                                                                <div>@p.PrinterOperator [@p.Printer]</div>
                                                                                            }
                                                                                        </td>
                                                                                        <td>@p.PlexCode</td>
                                                                                        <td>@p.TotalPrint</td>
                                                                                        @{
                                                                                            PrintTotal += p.TotalPrint;
                                                                                        }
                                                                                        <td>@p.StartSeqNum</td>
                                                                                        <td>@p.EndSeqNum</td>
                                                                                        @foreach (string paper in p.PaperTotals.Keys)
                                                                                        {
                                                                                            <td scope="row">@p.PaperTotals[paper]</td>
                                                                                            PaperTotal[paper] += p.PaperTotals[paper];
                                                                                        }
                                                                                        <td>@p.FullFillMaterialCode</td>
                                                                                        <td>@p.EnvMaterialRef</td>
                                                                                        <td>@p.TotalPostObjs</td>
                                                                                        @{
                                                                                            PostObjsTotal += p.TotalPostObjs;
                                                                                        }
                                                                                        @if (mInfo.StationList.Length > 0)
                                                                                        {
                                                                                            @foreach (string station in p.StationTotals.Keys)
                                                                                            {
                                                                                                <td scope="row">@p.StationTotals[station]</td>
                                                                                                StationTotal[station] += p.StationTotals[station];
                                                                                            }

                                                                                        }
                                                                                        <td>@p.ExpLevel</td>
                                                                                        <td>@eInfo.ExpCompanyCode</td>
                                                                                        <td class="hideextra">@p.ExpCenterCode</td>
                                                                                        <td class="hideextra">@p.ExpeditionZone</td>
                                                                                        <td class="hideextra">@eInfo.ExpeditionType</td>
                                                                                        <td class="hideextra">@p.ExpeditionLevel</td>
                                                                                    </tr>
                                                                                }
                                                                                <tr style="background:var(--lightestgrey)">
                                                                                    <b>
                                                                                    <td class="headcol" style="background:var(--lightergrey);">@localizer["Totals"]</td></b>
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    <td style="background:var(--lightergrey);">@PrintTotal</td>
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    @foreach (string paper in PaperTotal.Keys)
                                                                                    {
                                                                                        <td scope="row" style="background:var(--lightergrey);">@PaperTotal[paper]</td>
                                                                                    }
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    <td style="background:var(--lightergrey);">@PostObjsTotal</td>
                                                                                    @if (StationTotal.Count != 0)
                                                                                    {
                                                                                        @foreach (string station in StationTotal.Keys)
                                                                                        {
                                                                                            <td scope="row" style="background:var(--lightergrey);">@StationTotal[station]</td>
                                                                                        }
                                                                                    }
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    <td></td>
                                                                                    @*<td><a asp-area="EvolDP" asp-controller="DocCode" asp-action="DocCodeLevel1" asp-route-doclayout="@p.DocLayout" asp-route-docsubtype="@p.DocType">Mais</a></td>*@
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    }
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>
            }

        </form>
    </div>
}

@section Scripts
    {
    <script type="text/javascript">
        $(function () {
            $("#checkAll").click(function () {
                if ($(this).is(':checked')) {
                    $("#all").show();
                    $("#some").hide();
                } else {
                    $("#all").hide();
                    $("#some").show();
                }
            });
        });
        $("#Printer").change(function () {
            const prt = $(this).val().split("|").map(value => parseInt(value, 10));
            const elements = document.getElementsByName("FileCheck");
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                const values = element.id.split("|").map(value => parseInt(value, 10));
                if ((values[0] & prt[0]) > 0 && (values[1] & prt[1]) > 0) {
                    element.disabled = false;
                    //element.style.display = "";
                }
                else {
                    element.disabled = true;
                    //element.style.display = "none";
                    //element.checked = false;
                }
            }
        });
    </script>

}


